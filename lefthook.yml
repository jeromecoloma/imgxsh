# Lefthook configuration for imgxsh
# This runs validation checks before pushing to prevent CI failures

pre-push:
  commands:
    shellcheck:
      run: |
        echo "üîç Running ShellCheck..."
        if command -v shellcheck >/dev/null 2>&1; then
          # POSIX-safe: run shellcheck once on all files; non-zero if issues
          if ! find . -name "*.sh" -not -path "./tests/bats-*/*" -not -path "./shell-starter-tests/*" -exec shellcheck {} +; then
            echo "‚úñ ShellCheck found issues. Please fix them before pushing."
            echo "  Tip: run 'shellcheck <file>' to see details, or install an editor plugin."
            exit 1
          fi
        else
          echo "‚ö†Ô∏è  ShellCheck not found. Install with: brew install shellcheck"
          exit 1
        fi
      glob: "*.sh"
      
    shfmt:
      run: |
        echo "üé® Checking code formatting with shfmt..."
        if command -v shfmt >/dev/null 2>&1; then
          # Check formatting on all shell files and fail if diffs are produced
          diff_output=$(find . -name "*.sh" -not -path "./tests/bats-*/*" -not -path "./shell-starter-tests/*" -exec shfmt -d {} +)
          if [ -n "$diff_output" ]; then
            echo "$diff_output"
            echo "‚úñ shfmt detected formatting issues. Fix them with:"
            echo "  find . -name '*.sh' -not -path './tests/bats-*/*' -not -path './shell-starter-tests/*' -exec shfmt -w {} +"
            exit 1
          fi
        else
          echo "‚ö†Ô∏è  shfmt not found. Install with: brew install shfmt"
          exit 1
        fi
      glob: "*.sh"
      
    tests:
      run: |
        echo "üß™ Running tests..."
        if [ -f "./tests/run-tests.sh" ]; then
          chmod +x ./tests/run-tests.sh
          ./tests/run-tests.sh --ci
        else
          echo "‚ö†Ô∏è  Test runner not found: ./tests/run-tests.sh"
          exit 1
        fi
      glob: "*.{sh,bats}"
